<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="keyword" content="" />
    <title>Drone</title>
    <style type="text/css">
      .tuning {
        width: 100%;
      }

      .tuning input {
        width: 100%;
      }

      .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 32px;
        background: #e0e0e0;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
        border-radius: 16px;
        overflow: hidden;
      }

      .slider:hover {
        opacity: 1;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 32px;
        height: 32px;
        background: #202020;
        cursor: pointer;
        border-radius: 16px;
        box-shadow: -1000px 0 0 985px #808080;
      }

      .no-fill::-webkit-slider-thumb {
        box-shadow: none;
      }

      .slider::-moz-range-thumb {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div style="float: left;width: 40%;">
      <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="start()">Start</button>
        <button onclick="stop()">Stop</button>
        <button onclick="_clear()">Clear charts</button>
      </div>
      <div class="tuning">
        <label>Proportion (pitch): <span id="view_proportion1">0</span></label>
        <input type="range" id="proportion1" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_proportion1').innerHTML=parseInt(this.value)">
        <label>Integration (pitch): <span id="view_integration1">0</span></label>
        <input type="range" id="integration1" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_integration1').innerHTML=parseInt(this.value)">
        <label>Derivation (pitch): <span id="view_derivation1">0</span></label>
        <input type="range" id="derivation1" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_derivation1').innerHTML=parseInt(this.value)">

        <label>Proportion (roll): <span id="view_proportion2">0</span></label>
        <input type="range" id="proportion2" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_proportion2').innerHTML=parseInt(this.value)">
        <label>Integration (roll): <span id="view_integration2">0</span></label>
        <input type="range" id="integration2" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_integration2').innerHTML=parseInt(this.value)">
        <label>Derivation (roll): <span id="view_derivation2">0</span></label>
        <input type="range" id="derivation2" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_derivation2').innerHTML=parseInt(this.value)">

        <label>Proportion (yaw): <span id="view_proportion3">0</span></label>
        <input type="range" id="proportion3" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_proportion3').innerHTML=parseInt(this.value)">
        <label>Integration (yaw): <span id="view_integration">0</span></label>
        <input type="range" id="integration3" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_integration3').innerHTML=parseInt(this.value)">
        <label>Derivation (yaw): <span id="view_derivation3">0</span></label>
        <input type="range" id="derivation3" class="slider" min="-100" max="100" step="1" value="0" oninput="document.getElementById('view_derivation3').innerHTML=parseInt(this.value)">
      </div>
      <div>
        <div>
          <span style="width: 30%;display: inline-block;">Value 1: <span id="monitorValue1">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 4: <span id="monitorValue4">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 7: <span id="monitorValue7">None</span></span>
        </div>
        <div>
          <span style="width: 30%;display: inline-block;">Value 2: <span id="monitorValue2">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 5: <span id="monitorValue5">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 8: <span id="monitorValue8">None</span></span>
        </div>
        <div>
          <span style="width: 30%;display: inline-block;">Value 3: <span id="monitorValue3">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 6: <span id="monitorValue6">None</span></span>
          <span style="width: 30%;display: inline-block;">Value 9: <span id="monitorValue9">None</span></span>
        </div>
      </div>
    </div>
    <div style="float: left;width: 60%;">
      <canvas id="char1" style="width:100%;max-height: 200px;"></canvas>
      <canvas id="char2" style="width:100%;max-height: 200px;"></canvas>
      <canvas id="char3" style="width:100%;max-height: 200px;"></canvas>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script>
      let gSerialPort = null;
      let gRunning = false;

      let gChart1 = createChart('char1');
      let gChart2 = createChart('char2');
      let gChart3 = createChart('char3');

      async function connect() {
        gSerialPort = await navigator.serial.requestPort({});
        await gSerialPort.open({baudRate: 9600});
      }

      async function disconnect() {
        while (true) {
          try {
            await gSerialPort.close();
            break;
          }
          catch (e) {}
          await new Promise(r => setTimeout(r, 100));
        }
      }

      function createChart(canvasTagId) {
        return new Chart(canvasTagId, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              data: [],
              borderWidth: 2.0,
              borderColor: 'red',
              pointRadius: 1.0,
              fill: false
            },{
              data: [],
              borderWidth: 2.0,
              borderColor: 'green',
              pointRadius: 1.0,
              fill: false
            },{
              data: [],
              borderWidth: 2.0,
              borderColor: 'blue',
              pointRadius: 1.0,
              fill: false
            }]
          },
          options: {
            legend: {display: false},
            animation: {duration: 0},
          }
        });
      }

      function chartAdd(chart, label, data) {
        if (chart.data.labels.length > 64) {
          // Remove
          chart.data.labels.shift();
          chart.data.datasets.forEach((dataset) => {
            dataset.data.shift();
          });
        }

        // Add
        chart.data.labels.push(label);
        for (var i = 0; i < chart.data.datasets.length; i++) {
          chart.data.datasets[i].data.push(data[i]);
        }
        chart.update();
      }

      function charClear(chart) {
        while (chart.data.labels.length) { chart.data.labels.pop(); }
        chart.data.labels = [];
        chart.data.datasets.forEach((dataset) => {
          while (dataset.data.length) { dataset.data.pop(); }
        });
        chart.update();
      }

      function start() {
        gRunning = true;
      }

      function stop() {
        gRunning = false;
      }

      function _clear() {
        charClear(gChart1);
        charClear(gChart2);
        charClear(gChart3);
      }

      let gSensorValues = [0, 0, 0, 0, 0, 0, 0, 0, 0];

      let chartCol = 0;
      function updateCharts(monitorValues) {
        document.getElementById('monitorValue1').innerHTML = monitorValues[0];
        document.getElementById('monitorValue2').innerHTML = monitorValues[1];
        document.getElementById('monitorValue3').innerHTML = monitorValues[2];
        document.getElementById('monitorValue4').innerHTML = monitorValues[3];
        document.getElementById('monitorValue5').innerHTML = monitorValues[4];
        document.getElementById('monitorValue6').innerHTML = monitorValues[5];
        document.getElementById('monitorValue7').innerHTML = monitorValues[6];
        document.getElementById('monitorValue8').innerHTML = monitorValues[7];
        document.getElementById('monitorValue9').innerHTML = monitorValues[8];

        chartAdd(gChart1, chartCol, [monitorValues[0], monitorValues[1], monitorValues[2]]);
        chartAdd(gChart2, chartCol, [monitorValues[3], monitorValues[4], monitorValues[5]]);
        chartAdd(gChart3, chartCol, [monitorValues[6], monitorValues[7], monitorValues[8]]);
        chartCol += 1;
      }

      let gData = ''

      async function onMsg(msg) {
        console.log(msg);
        var start = gData.indexOf('[');
        var end = gData.indexOf(']');
        if (start > -1 && end > -1) {
          var data = gData.substring(start+1, end);
          var values = data.split(',');
          if (values.length != 9) return;
          gSensorValues[0]= parseInt(values[0])/100000;
          gSensorValues[1] = parseInt(values[1])/100000;
          gSensorValues[2] = parseInt(values[2])/100000;
          gSensorValues[3] = parseInt(values[3])/100000;
          gSensorValues[4] = parseInt(values[4])/100000;
          gSensorValues[5] = parseInt(values[5])/100000;
          gSensorValues[6] = parseInt(values[6])/100000;
          gSensorValues[7] = parseInt(values[7])/100000;
          gSensorValues[8] = parseInt(values[8])/100000;
          updateCharts(gSensorValues);
        }
      }

      setInterval(async () => {
        var idx = gData.indexOf('\n');
        if (idx > -1) {
          var msg = gData.substring(0, idx);
          onMsg(msg);
          gData = gData.substring(idx+1);
        }
      }, 100);

      setInterval(async () => {
        if (gSerialPort && gSerialPort.readable && gRunning) {
          if (gSerialPort.readable.locked) return;

          const reader = gSerialPort.readable.getReader();
          try {
            const { value, done } = await reader.read();
            var str = new TextDecoder().decode(value);
            gData += str;
          }
          catch (error) {
            console.log(error);
          }
          finally {
            reader.releaseLock();
          }
        }
      }, 100);

      setInterval(async () => {
        if (gSerialPort && gSerialPort.writable && gRunning) {
          const writer = gSerialPort.writable.getWriter();
          try {
            // var proportion1 = parseInt(document.getElementById('proportion1').value);
            // var integration1 = parseInt(document.getElementById('integration1').value);
            // var derivation1 = parseInt(document.getElementById('derivation1').value);
            // var proportion2 = parseInt(document.getElementById('proportion2').value);
            // var integration2 = parseInt(document.getElementById('integration2').value);
            // var derivation2 = parseInt(document.getElementById('derivation2').value);
            // var proportion3 = parseInt(document.getElementById('proportion3').value);
            // var integration3 = parseInt(document.getElementById('integration3').value);
            // var derivation3 = parseInt(document.getElementById('derivation3').value);
            await writer.write(new Uint8Array([254]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([proportion1]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([integration1]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([derivation1]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([proportion2]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([integration2]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([derivation2]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([proportion3]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([integration3]));
            // await new Promise(r => setTimeout(r, 20));
            // await writer.write(new Uint8Array([derivation3]));
            // await new Promise(r => setTimeout(r, 20));
          }
          catch (e) {
            console.log(e);
          }
          finally {
            writer.releaseLock();
          }
        }
      }, 150);
    </script>
  </body>
</html>